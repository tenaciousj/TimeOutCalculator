<!DOCTYPE html>
<head>
  <title>Time Out Calculator</title>
  <link rel="icon" href="http://cdn.mysitemyway.com/etc-mysitemyway/icons/legacy-previews/icons/glossy-black-icons-business/080723-glossy-black-icon-business-clock7-sc43.png">
  <!-- Latest compiled and minified CSS -->
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">

  <!-- Optional theme -->
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap-theme.min.css" integrity="sha384-fLW2N01lMqjakBkx3l/M9EahuwpSfeNvV63J5ezn3uZzapT0u7EYsXMjQV+0En5r" crossorigin="anonymous">

  <style>
    hr { width: 165px;}
    h1 { margin-left: 10px; }
  </style>
</head>

<body>
  <div class="page-header">
    <h1>Time Out Calculator <small>Calculate what time you can go home <button id="instr" type="button" data-target="#myModal" data-toggle="modal" class= "btn btn-sm btn-warning" onclick="showInstructions()">Instructions</button></small></h1>
  </div>
  <!-- Modal -->
  <div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
          <h4 class="modal-title" id="myModalLabel">How to Use the Time Out Calculator</h4>
        </div>
        <div class="modal-body">
          <ol>
            <li>Enter your Times In and Times Out throughout the day accordingly.</li>
            <li>Click "Add Time In" to add the latest time you have come in.</li>
            <li>Calculate what time you get to go home!</li>
          </ol>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-primary" data-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>
  <div class="container">
    <p><em>How many hours to work today?</em> <input id="hoursToWork" type="number" value="8" min="0" max="16" onchange="updateHoursToWork()" /></p>
    <hr align="left">
    <div id="app">
      <p>Time In: <input type="time" id="in-0"></p>
      <!-- <p>Time Out: &nbsp;<input type="time" id="out-0"></p> -->
    </div>
    <button id="addOut" type="button" class= "btn btn-info" onclick="addTime('Out')">Add Time Out</button>
    <button id="addIn" type="button" class= "btn btn-info" onclick="addTime('In')">Add Time In</button>

    <br><br>
    <button id="calc" type="button" class= "btn btn-primary" onclick="calculate()">Calculate</button>
    <p id="result"></p>
  </div>

  <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
  <!-- Latest compiled and minified JavaScript -->
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js" integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS" crossorigin="anonymous"></script>
  <script>
    var countIn = 1;
    var countOut = 0;
    var hoursToWork = document.getElementById("hoursToWork").value;
    var canCalculate = true;
    var canAddTimeIn = true;
    var lastAdded = "In";

    function updateHoursToWork(){
      hoursToWork = document.getElementById("hoursToWork").value;
    }

    function addTime(when){
      document.getElementById("result").innerHTML = "";
      var timeP = document.createElement("p");
      var id;
      if(lastAdded == when) {
        document.getElementById("result").innerHTML = "Can't add two Time Ins or Time Outs in a row.";
        return;
      }
      if(when == "In"){
        id = "in-" + countIn++;
        canCalculate = true;
      } else {
        id = "out-" + countOut++;
        canCalculate = false;
      }
      lastAdded = when;
      timeP.innerHTML = "<hr align='left'>Time " + when + ": <input type='time' id='"+id+"'>";
      document.getElementById("app").appendChild(timeP);
    }
    function calculate() {
      if (!canCalculate) {
        document.getElementById("result").innerHTML = "Cannot calculate unless you Add Time In.";
        return;
      }
      var length = Math.floor(document.getElementById("app").getElementsByTagName("p").length / 2);
      var HRS = 0;
      var MINS = 0;
      var lastOutTime;
      for(var i = 0; i < length; i++) {
        var inTime = document.getElementById("in-" + i).value; var outTime = document.getElementById("out-" + i).value;
        var inHM = getEnteredTime(inTime); var outHM = getEnteredTime(outTime);
        var inDate = new Date(); var outDate = new Date();
        inDate.setHours(inHM[0]); outDate.setHours(outHM[0]);
        inDate.setMinutes(inHM[1]); outDate.setMinutes(outHM[1]);

        //last out time
        if(i == length - 1) {
          lastOutTime = outHM;
        }

        var diffMs = outDate - inDate;
        var diffHrs = Math.round((diffMs % 86400000) / 3600000); // hours
        var diffMins = Math.round(((diffMs % 86400000) % 3600000) / 60000); // minutes

        HRS += diffHrs;
        MINS += diffMins;

      }
      while (MINS >= 60){
        HRS += 1;
        MINS -= 60;
      }

      //no time was logged
      if(HRS == 0 && MINS == 0 && countIn > 1) {
        document.getElementById("result").innerHTML = resultStr;
        return;
      }

      //negative time calculated
      if(HRS < 0 || MINS < 0) {
        document.getElementById("result").innerHTML = "Negative time was calculated. Was your entered Out Time before your entered In Time?";
        return;
      }

      var hrsLeft = hoursToWork - 1 - HRS;
      var minsLeft = 60 - MINS;

      while (minsLeft >= 60){
        hrsLeft += 1;
        minsLeft -= 60;
      }

      var resultStr = "<p>" + hrsLeft + " hours and " + minsLeft + " minutes left.</p>";

      var lastInTime = document.getElementById("in-" + parseInt(countIn-1)).value;
      var lastInHM = getEnteredTime(lastInTime);

      if (countIn > 1) {
        if(lastOutTime[0] > lastInHM[0] || (lastOutTime[0] == lastInHM[0] && lastOutTime[1] > lastInHM[1])){
          document.getElementById("result").innerHTML = "Your last In time is before your last Out time. Please update your times and try again.";
          return;
        }
      }
      var endHr = parseInt(lastInHM[0]) + hrsLeft;
      var endMin = parseInt(lastInHM[1]) + minsLeft;

      while (endMin >= 60){
        endHr += 1;
        endMin -= 60;
      }

      var meridian = "AM";
      debugger;
      if (endHr > 12){
        endHr -= 12;
        meridian = "PM;"
      }
      if (endMin < 10){
        endMin = "0" + endMin;
      }

      resultStr += "<p>To work " + hoursToWork + " hours, stay until <strong>" + endHr + ":" + endMin + meridian + "</strong></p>";

      document.getElementById("result").innerHTML = resultStr;

    }
    function getEnteredTime(str) {
      var h = str.substring(0, str.indexOf(":"));
      var m = str.substring(str.indexOf(":")+1, str.length);
      return [h,m];
    }
  </script>
</body>



</html>
